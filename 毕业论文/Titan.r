library(stargazer)
library(forecast)
library(tseries)
library(TSA)
library(glmnet)
library(car)
row.data = read.csv('Bond.CSV',header = F)
Bond=data.frame(c(0,1/12,2/12,3/12,6/12,9/12,1,2,3,5,7,10,15,20,30,40,50),as.numeric(row.data$V2)[1:17]/100)
colnames(Bond)=c('Maturity','YTM')
rownames(Bond)=row.data[,1]
plot(Bond$YTM~Bond$Maturity,xlab='Maturity',ylab='YTM',main='Bond Yield Curve')
x=seq(0,50,0.001)
y=0.0360283711489497-0.0297453066371509*(1-exp(-x/2.73996629729423))/(x/2.73996629729423)-0.00756080264931528*((1-exp(-x/2.73996629729423))/(x/2.73996629729423)-exp(-x/2.73996629729423))+0.0096713146710982*((1-exp(-x/0.347139253269968))/(x/0.347139253269968)-exp(-x/0.347139253269968))
jpeg('plot1.jpg')
plot(y~x,type='l',xlab='到期年限/年',ylab='到期收益率',main='债券收益率曲线')
points(x=Bond$Maturity,y=Bond$YTM)
dev.off()
x=c(0,1/12,2/12,3/12,6/12,9/12,1,2,3,5,7,10,15,20,30,40,50)
sum((y[-1]-Bond$YTM[-1])^2)
row.data.1=read.csv("TS.csv")
Bond.Index=rev(row.data.1$Price.1-row.data.1$Price)[c(-6:-1)]
Bond.Index=ts(Bond.Index,start = c(2015,1),frequency = 12)
Bond.Index.Quarter=ts(rev(row.data.1$X.2)[seq(6,66,3)],start = c(2014,4),frequency = 4)
jpeg('plot2.jpg')
plot(Bond.Index,type='b',xlab='时间/月',ylab='风险溢价指标/元')
dev.off()
jpeg('plot3.jpg')
plot(diff(Bond.Index),type='b',xlab='时间/月',ylab='风险溢价差值/元')
dev.off()
summary(auto.arima(Bond.Index))
adf.test(diff(Bond.Index),k=0)
Box.test(diff(Bond.Index),lag = 10,type = 'Ljung')
jpeg('plot4.jpg')
plot(diff(Bond.Index)-0.2280,xlab='时间/月',ylab='残差（预测值-真实值）')
dev.off()
jpeg('plot5.jpg')
qqnorm(diff(Bond.Index)-0.2280)
qqline(residuals(Arima(diff(Bond.Index),c(0,1,0),include.constant =  T )))
dev.off()
tenY.Rate=ts(rev(row.data.1$X.3[-1])[seq(9,66,3)],start = c(2015,1),frequency = 4)
Index=ts(rev(row.data.1$X.4[-1])[seq(9,66,3)],start = c(2015,1),frequency = 4)
ER=ts((row.data.1$X.5)[seq(1,60,3)],start = c(2015,1),frequency = 4)
GDP=ts(row.data.1$X100.million.yuan[1:22],start = c(2014,3),frequency = 4)
CPI=ts(row.data.1$X.7[seq(1,60,3)],start = c(2015,1),frequency = 4)
M.1=ts(row.data.1$X.10[seq(1,64,3)],start = c(2014,3),frequency = 4)
Factors= cbind(diff(Bond.Index.Quarter),diff(GDP)[-1],diff(M.1)[-1],ER,Index,CPI,tenY.Rate)
jpeg('plot19.jpg')
plot(Factors,ylab='',xlab='时间/季度',main='')
dev.off()
cor(Factors)
summary(lm(diff(Bond.Index.Quarter)~diff(GDP)[-1]+diff(M.1)[-1]))
jpeg('plot7.jpg')
plot(diff(Bond.Index.Quarter),xlab='时间/季度',ylab='风险溢价差值/元')
points(lm(diff(Bond.Index.Quarter)~diff(GDP)[-1]+diff(M.1)[-1])$fitted.values,x=seq(2015,2019.75,0.25),type='l',lty=2)
legend("topright",legend = c('真实值','预测值'),lty=c(1,2))
dev.off()
jpeg('plot8.jpg')
plot(diff(GDP),xlab='时间/季度',ylab='增长金额/亿元',ylim=c(-40000,80000))
points(diff(M.1),x=seq(2014.75,2019.75,0.25),type='l',lty=2)
legend("topright",legend = c('GDP','M2'),lty=c(1,2))
dev.off()
GDP.train=ts(row.data.1$X100.million.yuan[1:18],start = c(2014,3),frequency = 4)
M.1.train=ts(row.data.1$X.10[seq(1,52,3)],start = c(2014,3),frequency = 4)
GDP.test=ts(row.data.1$X100.million.yuan[19:22],start = c(2014,3),frequency = 4)
M.1.test=ts(row.data.1$X.10[seq(55,64,3)],start = c(2014,3),frequency = 4)
a=diff(GDP.train)[-1]
b=diff(M.1.train)[-1]
newdata=data.frame(a=diff(GDP.test),b=diff(M.1.test))
c=lm(diff(Bond.Index.Quarter)[1:16]~a+b)
predict(c,newdata = newdata)
plot(diff(Bond.Index.Quarter))
points(x=seq(2015,2019.5,0.25),y=c(c$fitted.values,predict(c,newdata = newdata)),type = 'b')



Corporation=read.csv("Corporation.csv")
cor(Corporation[,-1])
Risk.Premium=ts(Corporation$理论信用利差,start=c(2016,2),frequency=4)
summary(step(lm(Corporation$理论信用利差~.,Corporation[,-1]),direction='backward'))
jpeg('plot11.jpg')
plot(Risk.Premium,xlab='时间/季度',ylab='风险溢价')
points(lm(Corporation$理论信用利差~.,Corporation[,c(-1,-6,-4)])$fitted.values,x=seq(2016.25,2018.25,0.25))
dev.off()
summary(lm(Corporation$理论信用利差~.,Corporation[,c(-1,-6,-4)]))
jpeg('plot12.jpg')
plot(lm(Corporation$理论信用利差~.,Corporation[,c(-1,-6,-4)])$residuals,ylab='预测值 - 真实值')
dev.off()
jpeg('plot13.jpg')
qqnorm(lm(Corporation$理论信用利差~.,Corporation[,c(-1,-6,-4)])$residuals)
qqline(lm(Corporation$理论信用利差~.,Corporation[,c(-1,-6,-4)])$residuals)
dev.off()
jpeg('plot14.jpg')
boxCox(lm(Corporation.New$理论信用利差~.,Corporation.New))
dev.off()

Corporation.New=Corporation[-5,c(-1,-6,-4)]
summary(lm(log(Corporation.New$理论信用利差)~.,Corporation.New))
jpeg('plot16.jpg')
plot(lm(log(Corporation.New$理论信用利差)~.,Corporation.New)$residuals,ylab='预测值 - 真实值')
dev.off()
jpeg('plot18.jpg')
plot(log(Risk.Premium),xlab='时间/季度',ylab='风险溢价')
points(lm(log(Corporation.New$理论信用利差)~.,Corporation.New)$fitted.values,x=c(seq(2016.25,2017,0.25),seq(2017.5,2018.25,0.25)))
dev.off()
jpeg('plot17.jpg')
qqnorm(lm(log(Corporation.New$理论信用利差)~.,Corporation.New)$residuals)
qqline(lm(log(Corporation.New$理论信用利差)~.,Corporation.New)$residuals)
dev.off()